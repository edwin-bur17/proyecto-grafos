{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navegaci√≥n por Tienda üó∫Ô∏è</title>
    <link rel="stylesheet" href="{% static 'grafos/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'grafos/css/map-view.css' %}">
    
    <!-- Vis.js Network for graph visualization -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    
    <script src="{% static 'grafos/js/shopping.js' %}" defer></script>
</head>
<body class="map-view-body">
    {% if ruta_resultado %}
    <!-- Layout tipo Google Maps -->
    <div class="maps-layout">
        <!-- Panel Lateral Izquierdo -->
        <div class="sidebar-panel">
            <div class="sidebar-header">
                <h1 class="sidebar-title">üó∫Ô∏è Tu Ruta de Compras</h1>
                <p class="sidebar-subtitle">{{ ruta_resultado.productos|length }} productos ¬∑ {{ ruta_resultado.pasillos_necesarios|length }} pasillos</p>
            </div>

            <!-- B√∫squeda de productos -->
            <div class="search-box">
                <input type="text" id="searchProducts" placeholder="üîç Buscar productos..." class="search-input">
            </div>

            <!-- Pesta√±as: Rutas vs Productos -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="routes">Rutas</button>
                <button class="tab-btn" data-tab="products">Productos</button>
            </div>

            <!-- Panel de Rutas -->
            <div id="tab-routes" class="tab-content active">
                <div class="routes-list">
                    {% for ruta in ruta_resultado.rutas %}
                    <div class="route-card {% if ruta.es_optima %}optimal{% endif %}" 
                         data-route-id="{{ ruta.id }}"
                         onclick="seleccionarRuta({{ ruta.id }})">
                        <div class="route-header">
                            <span class="route-badge">
                                {% if ruta.es_optima %}‚≠ê{% else %}{{ forloop.counter }}{% endif %}
                            </span>
                            <div class="route-info">
                                <h3 class="route-title">{{ ruta.nombre }}</h3>
                                <p class="route-meta">
                                    <span class="badge badge-blue">{{ ruta.ruta|length }} pasos</span>
                                    <span class="badge badge-green">Costo: {{ ruta.costo }}</span>
                                </p>
                            </div>
                        </div>
                        <div class="route-preview">
                            {{ ruta.ruta|join:" ‚Üí " }}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Detalles de la ruta activa -->
                <div class="route-timeline">
                    <h3 class="timeline-title">Detalles del Recorrido</h3>
                    <div id="route-steps-container">
                        <!-- Se llena din√°micamente con JS -->
                    </div>
                </div>
            </div>

            <!-- Panel de Productos -->
            <div id="tab-products" class="tab-content">
                <div class="products-manager">
                    <div class="products-count">
                        <span id="productsCount">{{ ruta_resultado.productos|length }}</span> productos seleccionados
                    </div>
                    
                    <div class="products-grid" id="productsList">
                        {% for producto in ruta_resultado.productos %}
                        <div class="product-item" data-product="{{ producto.nombre }}">
                            <div class="product-info">
                                <h4 class="product-name">{{ producto.nombre }}</h4>
                                <p class="product-details">{{ producto.marca }}</p>
                                <span class="product-location">üìç {{ producto.pasillo }}</span>
                            </div>
                            <button class="product-remove" 
                                    onclick="eliminarProducto('{{ producto.nombre }}')"
                                    title="Eliminar {{ producto.nombre }} y recalcular ruta">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M12.854 3.146a.5.5 0 0 1 0 .708l-9 9a.5.5 0 0 1-.708-.708l9-9a.5.5 0 0 1 .708 0z"/>
                                    <path d="M3.146 3.146a.5.5 0 0 0 0 .708l9 9a.5.5 0 0 0 .708-.708l-9-9a.5.5 0 0 0-.708 0z"/>
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="products-actions">
                        <a href="{% url 'inicio' %}" class="btn-action btn-outline">
                            ‚ûï Agregar M√°s Productos
                        </a>
                        <a href="{% url 'limpiar_seleccion' %}" class="btn-action btn-danger" 
                           onclick="return confirm('¬øDeseas limpiar toda la selecci√≥n?');">
                            üóëÔ∏è Nueva Compra
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- √Årea del Mapa Principal -->
        <div class="map-area">
            <!-- Controles superiores -->
            <div class="map-controls">
                <div class="control-group">
                    <button class="control-btn" onclick="zoomIn()" title="Acercar">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 4a1 1 0 011 1v4h4a1 1 0 110 2h-4v4a1 1 0 11-2 0v-4H5a1 1 0 110-2h4V5a1 1 0 011-1z"/>
                        </svg>
                    </button>
                    <button class="control-btn" onclick="zoomOut()" title="Alejar">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M5 9a1 1 0 100 2h10a1 1 0 100-2H5z"/>
                        </svg>
                    </button>
                    <button class="control-btn" onclick="resetView()" title="Centrar">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="route-stats-bar">
                    <div class="stat">
                        <span class="stat-label">Distancia</span>
                        <span class="stat-value" id="routeDistance">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Pasos</span>
                        <span class="stat-value" id="routeSteps">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Productos</span>
                        <span class="stat-value">{{ ruta_resultado.productos|length }}</span>
                    </div>
                </div>
            </div>

            <!-- Contenedor del Grafo (Vis.js Network) -->
            <div class="map-canvas" id="mapCanvas">
                <div id="network-graph" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- Leyenda -->
            <div class="map-legend">
                <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: #2c3e50;">üìç Leyenda</h4>
                <div class="legend-item">
                    <span class="legend-icon" style="background: #28a745;">üö™</span>
                    <span class="legend-text">Entrada</span>
                </div>
                <div class="legend-item">
                    <span class="legend-icon" style="background: #667eea;">üì¶</span>
                    <span class="legend-text">Con productos</span>
                </div>
                <div class="legend-item">
                    <span class="legend-icon" style="background: #6c757d;">‚û°Ô∏è</span>
                    <span class="legend-text">Paso intermedio</span>
                </div>
                <div class="legend-item">
                    <span class="legend-icon" style="background: #dc3545;">üõí</span>
                    <span class="legend-text">Cajas</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos del servidor
        const productosPorPasillo = {{ ruta_resultado.productos_por_pasillo|to_json }};
        const rutasDisponibles = {{ ruta_resultado.rutas|to_json }};
        const graphStructure = {{ ruta_resultado.graph_structure|to_json }};
        let rutaActiva = null;
        let network = null;

        // Configuraci√≥n de colores
        const COLORS = {
            start: '#28a745',
            end: '#dc3545',
            aisle: '#6c757d',
            hasProducts: '#667eea',
            transit: '#95a5a6',
            optimal: '#667eea',
            alternative1: '#28a745',
            alternative2: '#f39c12',
            baseEdge: '#dee2e6'
        };

        // Inicializar grafo con Vis.js Network
        function inicializarGrafo() {
            const container = document.getElementById('network-graph');
            
            // Preparar nodos desde graphStructure
            const nodes = new vis.DataSet(
                graphStructure.nodes.map(node => {
                    const tieneProductos = productosPorPasillo[node.id] && productosPorPasillo[node.id].length > 0;
                    let color = COLORS[node.type];
                    if (tieneProductos && node.type === 'aisle') {
                        color = COLORS.hasProducts;
                    }
                    
                    return {
                        id: node.id,
                        label: `${node.icon}\n${node.label}`,
                        title: node.id, // Tooltip
                        color: {
                            background: color,
                            border: color,
                            highlight: {
                                background: color,
                                border: '#2c3e50'
                            }
                        },
                        font: {
                            color: '#ffffff',
                            size: 14,
                            face: 'Arial',
                            bold: true
                        },
                        shape: node.type === 'start' ? 'triangle' : (node.type === 'end' ? 'box' : 'circle'),
                        size: tieneProductos ? 35 : 25,
                        borderWidth: 3,
                        shadow: true
                    };
                })
            );

            // Preparar aristas desde graphStructure
            const edges = new vis.DataSet(
                graphStructure.edges.map(edge => ({
                    from: edge.from,
                    to: edge.to,
                    color: {
                        color: COLORS.baseEdge,
                        highlight: '#667eea'
                    },
                    width: 2,
                    smooth: {
                        enabled: true,
                        type: 'continuous'
                    },
                    label: String(edge.weight),
                    font: {
                        size: 10,
                        color: '#7f8c8d'
                    }
                }))
            );

            const data = { nodes, edges };

            const options = {
                physics: {
                    enabled: true,
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        gravitationalConstant: -50,
                        centralGravity: 0.01,
                        springLength: 200,
                        springConstant: 0.08,
                        damping: 0.4,
                        avoidOverlap: 0.5
                    },
                    stabilization: {
                        enabled: true,
                        iterations: 200,
                        updateInterval: 25
                    }
                },
                interaction: {
                    hover: true,
                    zoomView: true,
                    dragView: true,
                    dragNodes: true,
                    tooltipDelay: 100
                },
                edges: {
                    arrows: {
                        to: {
                            enabled: false
                        }
                    }
                },
                layout: {
                    improvedLayout: true,
                    hierarchical: false
                }
            };

            network = new vis.Network(container, data, options);

            // Esperar a que la f√≠sica se estabilice
            network.on('stabilizationIterationsDone', function () {
                network.setOptions({ physics: false });
            });

            // Seleccionar primera ruta
            if (rutasDisponibles && rutasDisponibles.length > 0) {
                seleccionarRuta(rutasDisponibles[0].id);
            }
        }

        function seleccionarRuta(id) {
            const ruta = rutasDisponibles.find(r => r.id === id);
            if (!ruta) return;
            
            rutaActiva = ruta;
            
            // Actualizar UI de las tarjetas de rutas
            document.querySelectorAll('.route-card').forEach(card => {
                card.classList.toggle('active', card.dataset.routeId == id);
            });
            
            // Actualizar stats
            document.getElementById('routeDistance').textContent = ruta.costo;
            document.getElementById('routeSteps').textContent = ruta.ruta.length;
            
            // Resaltar ruta en el grafo
            resaltarRutaEnGrafo(ruta);
            actualizarTimeline(ruta.ruta);
        }

        function resaltarRutaEnGrafo(ruta) {
            if (!network) return;

            const nodes = network.body.data.nodes;
            const edges = network.body.data.edges;

            // Resetear todos los bordes a color base
            edges.forEach(edge => {
                edges.update({
                    id: edge.id,
                    color: { color: COLORS.baseEdge },
                    width: 2,
                    arrows: { to: { enabled: false } }
                });
            });

            // Resetear todos los nodos
            nodes.forEach(node => {
                const nodeData = graphStructure.nodes.find(n => n.id === node.id);
                const tieneProductos = productosPorPasillo[node.id] && productosPorPasillo[node.id].length > 0;
                let color = COLORS[nodeData.type];
                if (tieneProductos && nodeData.type === 'aisle') {
                    color = COLORS.hasProducts;
                }
                
                nodes.update({
                    id: node.id,
                    color: {
                        background: color,
                        border: color
                    },
                    borderWidth: 3,
                    size: tieneProductos ? 35 : 25
                });
            });

            // Resaltar la ruta seleccionada
            const rutaPath = ruta.ruta;
            for (let i = 0; i < rutaPath.length - 1; i++) {
                const desde = rutaPath[i];
                const hacia = rutaPath[i + 1];
                
                // Encontrar la arista
                const edgeId = edges.get({
                    filter: item => (item.from === desde && item.to === hacia) || 
                                   (item.from === hacia && item.to === desde)
                })[0];

                if (edgeId) {
                    const color = ruta.es_optima ? COLORS.optimal : 
                                (ruta.id === 1 ? COLORS.alternative1 : COLORS.alternative2);
                    
                    edges.update({
                        id: edgeId.id,
                        color: {
                            color: color,
                            highlight: color
                        },
                        width: ruta.es_optima ? 6 : 4,
                        arrows: {
                            to: {
                                enabled: true,
                                scaleFactor: 0.5
                            }
                        }
                    });
                }
            }

            // Resaltar nodos en la ruta
            rutaPath.forEach(nodeId => {
                const nodeData = graphStructure.nodes.find(n => n.id === nodeId);
                const tieneProductos = productosPorPasillo[nodeId] && productosPorPasillo[nodeId].length > 0;
                
                let color = COLORS[nodeData.type];
                if (tieneProductos && nodeData.type === 'aisle') {
                    color = COLORS.hasProducts;
                }
                
                nodes.update({
                    id: nodeId,
                    borderWidth: 5,
                    color: {
                        background: color,
                        border: '#2c3e50'
                    },
                    size: tieneProductos ? 40 : 30
                });
            });
        }

        function actualizarTimeline(ruta) {
            const container = document.getElementById('route-steps-container');
            container.innerHTML = '';
            
            ruta.forEach((paso, index) => {
                const productos = productosPorPasillo[paso] || [];
                const nodoInfo = graphStructure.nodes.find(n => n.id === paso);
                const div = document.createElement('div');
                div.className = 'timeline-step' + (productos.length > 0 ? ' has-products' : '');
                
                div.innerHTML = `
                    <div class="timeline-marker">${index + 1}</div>
                    <div class="timeline-content">
                        <h4 class="timeline-title">${nodoInfo?.icon || 'üìç'} ${paso}</h4>
                        ${productos.length > 0 ? `
                            <div class="timeline-products">
                                <strong>Recoger ${productos.length} producto${productos.length > 1 ? 's' : ''}:</strong>
                                <ul>${productos.map(p => `<li>${p.nombre}</li>`).join('')}</ul>
                            </div>
                        ` : '<p class="timeline-transit">Punto de paso</p>'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Funciones de control (mantener para compatibilidad con botones)
        function zoomIn() {
            if (network) {
                const scale = network.getScale();
                network.moveTo({ scale: scale * 1.2 });
            }
        }

        function zoomOut() {
            if (network) {
                const scale = network.getScale();
                network.moveTo({ scale: scale / 1.2 });
            }
        }

        function resetView() {
            if (network) {
                network.fit({ animation: true });
            }
        }

        // Gesti√≥n de productos
        function eliminarProducto(nombre) {
            if (!confirm(`¬øEliminar "${nombre}" de tu ruta?\n\nLa ruta se recalcular√° autom√°ticamente.`)) return;
            
            // Mostrar indicador de carga
            const productItem = document.querySelector(`[data-product="${nombre}"]`);
            if (productItem) {
                productItem.classList.add('removing');
            }
            
            // Actualizar sessionStorage ANTES de redirigir
            try {
                const stored = sessionStorage.getItem('productos_seleccionados');
                if (stored) {
                    let productos = JSON.parse(stored);
                    productos = productos.filter(p => p !== nombre);
                    sessionStorage.setItem('productos_seleccionados', JSON.stringify(productos));
                }
            } catch (error) {
                console.error('Error al actualizar sessionStorage:', error);
            }
            
            // Redirigir al endpoint de eliminaci√≥n (CORREGIDO: sin /grafos/)
            window.location.href = `/eliminar-producto/${encodeURIComponent(nombre)}/`;
        }

        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.add('active');
            });
        });

        // B√∫squeda de productos
        document.getElementById('searchProducts')?.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.product-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'flex' : 'none';
            });
        });

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', inicializarGrafo);
    </script>
    {% else %}
    <!-- Sin ruta -->
    <div class="container" style="padding: 2rem;">
        <div class="card">
            <h2 class="card-title">No hay ruta calculada</h2>
            <p>Por favor, selecciona productos primero.</p>
            <a href="{% url 'inicio' %}" class="btn btn-primary">Ir a Selecci√≥n de Productos</a>
        </div>
    </div>
    {% endif %}
</body>
</html>
